#                _
#   ___ _   _ ___| |_ ___ _ __ ___
#  / __| | | / __| __/ _ \ _ ` _ \
#  \__ \ |_| \__ \ ||  __/ | | | | |
#  |___/\__, |___/\__\___|_| |_| |_|
#       |___/
#

system:
  data_word_width: 64 # Host bus information.
  host_word_width: 32 # Fixed, for now.
  num_test_data_memory_words: 32786 # Test memory system.
  test_data_memory_buffer_depth: 4


module_type: cgra.fabric.Cgra_Hw
input_ports: [i1,i2]
output_ports: [o1,o2]

#     ____             _
#    |  _ \ ___  _   _| |_ ___ _ __
#    | |_) / _ \| | | | __/ _ \ __|
#    |  _ < (_) | |_| | ||  __/ |
#    |_| \_\___/ \__,_|\__\___|_|
#

routers:
  default: &default_router
    module_type: cgra.fabric.router
    # Input / Output
    input_ports: [north,south,east,west,northeast,northwest,southeast,southwest]
    output_ports: [north,south,east,west,northeast,northwest,southeast,southwest]
    config_input_port: north
    config_output_port: south
    # Data Word Width use global or not
    use_global: true
    # Decomposability
    isDecomposed: true
    decomposer: 8
    # Protocol (Ready = Dynamic, Non-Ready = Static)
    protocol: DataValidReady
    # Shared
    isShared: true
    back_pressure_fifo_depth: 2
    shared_slot_size: 32
    # Interconnection between Subent
    inter_subnet_connection: []

  router_1: &router_1
    <<: *default_router
    config_input_port: west
    config_output_port: southeast

  router_2: &router_2
    <<: *default_router
    config_input_port: north
    config_output_port: east


  router_3: &router_3
    <<: *default_router
    config_input_port: west
    config_output_port: southwest


  router_4: &router_4
    <<: *default_router
    config_output_port: southwest

  router_5: &router_5
    <<: *default_router
    config_input_port: east
    config_output_port: southeast

  router_6: &router_6
    <<: *default_router
    config_input_port: northwest
    config_output_port: west
    input_ports: [north,south,east,west,northwest,northeast]
    decomposer: 2
    # Inter-Sub-Net-Communication [Optional]
    inter_subnet_connection: [
      south_1 <-> north_0,
      northeast_0 <-> east _1
    ]

  router_7: &router_7
    <<: *default_router
    config_input_port: northwest
    config_output_port: southwest
    input_ports: [north,south,east,west,northwest,southeast]

  router_8: &router_8
    <<: *default_router
    config_input_port: northwest
    config_output_port: southwest
    input_ports: [north,south,east,west,northwest,southwest]


  router_9: &router_9
    <<: *default_router
    config_input_port: east
    config_output_port: southeast

  router_10: &router_10
    <<: *default_router
    config_input_port: northwest
    config_output_port: west

  router_11: &router_11
    <<: *default_router
    config_input_port: northwest
    config_output_port: southwest
    input_ports: [north,south,east,west,northwest,northeast,southeast]

  router_12: &router_12
    <<: *default_router
    config_input_port: northwest
    config_output_port: southwest
    input_ports: [north,south,east,west,northwest,southwest]

  router_13: &router_13
    <<: *default_router
    config_input_port: north
    config_output_port: south


  router_14: &router_14
    <<: *default_router
    config_input_port: northwest
    config_output_port: west


  router_15: &router_15
    <<: *default_router
    input_ports: [north,south,east,west,northwest,northeast]
    config_input_port: northwest
    config_output_port: south

  router_16: &router_16
    <<: *default_router
    config_input_port: northwest
    config_output_port: east

#   ____           _ _           _           _   ____  _____
#  |  _ \  ___  __| (_) ___ __ _| |_ ___  __| | |  _ \| ____|
#  | | | |/ _ \/ _` | |/ __/ _` | __/ _ \/ _` | | |_) |  _|
#  | |_| |  __/ (_| | | (_| (_| | ||  __/ (_| | |  __/| |___
#  |____/ \___|\__,_|_|\___\__,_|\__\___|\__,_| |_|   |_____|
#

dedicated_pes:
  default_dedicated_pe: &default_dedicated_pe
    module_type: cgra.fabric.dedicated_pe
    use_global: true
    # Config
    config_input_port: northwest
    config_output_port: southeast
    # Input Output Capability
    input_ports: [northwest,northeast,southwest,southeast]
    output_ports: [southeast]
    # Decomposability
    isDecomposed: true
    decomposer: 1
    # Protocol
    protocol: DataValidReady
    # Control
    has_metaReuse: {valid: false,num_reuse: 4} #TODO
    # Shared Instruction
    isShared: true
    shared_slot_size: 32
    register_file_size: 8
    # Datapath
    delay_fifo_depth: 2 # Delay Pipe when protocol don't has Ready; Delay FIFO when protocol has Ready
    instructions: [Sub,BOr,BAnd,Add]
    output_select_mode: Universal #[ Individual ]

  dedicated_pe_1: &dedicated_pe_1
    <<: *default_dedicated_pe

  dedicated_pe_2: &dedicated_pe_2
    <<: *default_dedicated_pe
    output_ports: [southeast,southwest]
    config_input_port: northeast
    instructions: [Add,Sub,Div,Mul,BOr,BAnd]

  dedicated_pe_3: &dedicated_pe_3
    <<: *default_dedicated_pe
    config_input_port: northeast
    decomposer: 2

  dedicated_pe_4: &dedicated_pe_4
    <<: *default_dedicated_pe


  dedicated_pe_5: &dedicated_pe_5
    <<: *default_dedicated_pe
    config_input_port: northeast
    instructions: [GT,GE,LT,LE]

  dedicated_pe_6: &dedicated_pe_6
    <<: *default_dedicated_pe

  dedicated_pe_7: &dedicated_pe_7
    <<: *default_dedicated_pe
    config_input_port: northeast
    instructions: [LShf,Div]

#   ____  _                        _   ____  _____
#  / ___|| |__   __ _ _ __ ___  __| | |  _ \| ____|
#  \___ \| _   \/ _` | _ _/ _ \/ _` | | |_) |  _|
#   ___) | | | | (_| | | |  __/ (_| | |  __/| |___
#  |____/|_| |_|\__,_|_|  \___|\__,_| |_|   |_____|
#

shared_pes:
  default_shared_pe: &default_shared_pe
    module_type: cgra.fabric.shared_pe
    # I/O
    input_ports: [northwest,northeast,southwest,southeast]
    output_ports: [northwest,northeast,southwest,southeast]
    # Base architecture.
    architecture: integer
    immediate_width: 32
    mm_instruction_width: 128
    instructions: [Sub,Div,Mul,BOr,BAnd]
    num_instructions: 16
    num_predicates: 8
    num_registers: 8
    # Instruction features.
    has_multiplier: true
    has_two_word_product_multiplier: true
    has_scratchpad: false
    num_scratchpad_words: 512
    spm_depth: 8
    # Instruction memory microarchitecture.
    latch_based_instruction_memory: false
    ram_based_immediate_storage: false
    # Channels.
    channel_buffer_depth: 2 # Must be >= 2.
    max_num_input_channels_to_check: 2
    num_tags: 3
    # Pipeline features.
    has_speculative_predicate_unit: true
    has_effective_queue_status: true
    # Debugging and profiling features.
    has_debug_monitor: true
    has_performance_counters: true
    has_software_router: false
    has_switch_router: true
    num_physical_planes: 1
    memory_link_buffer_fifo_depth: 4
    num_data_memory_words: 32786
    num_scratchpad_words_if_enabled: 512

  shared_pe_1: &shared_pe_1
    <<: *default_shared_pe

  shared_pe_2: &shared_pe_2
    <<: *default_shared_pe

#  __     __        _               ____            _
#  \ \   / /__  ___| |_ ___  _ __  |  _ \ ___  _ __| |_
#   \ \ / / _ \/ __| __/ _ \| '__| | |_) / _ \| '__| __|
#    \ V /  __/ (__| || (_) | |    |  __/ (_) | |  | |_
#     \_/ \___|\___|\__\___/|_|    |_|   \___/|_|   \__|
vector_ports:
  default_vp: &default_vp
    io_type: ""
    module_type: cgra.fabric.vector_port
    input_ports: [v1,v2,v3]
    output_ports: [v1,v2,v3]
    channel_buffer:

  vec_in_1: &vec_in_1
    <<: *default_vp
    io_type: in
    input_ports: [v1]

  vec_in_2: &vec_in_2
    <<: *default_vp
    io_type: in
    input_ports: [v1]

  vec_out_1: &vec_out_1
    <<: *default_vp
    io_type: out
    output_ports: [v1]

  vec_out_2: &vec_out_2
    <<: *default_vp
    io_type: out
    output_ports: [v1]

#   _____                 _
#  |_   _|__  _ __   ___ | | ___   __ _ _   _
#    | |/ _ \| '_ \ / _ \| |/ _ \ / _` | | | |
#    | | (_) | |_) | (_) | | (_) | (_| | |_| |
#    |_|\___/| .__/ \___/|_|\___/ \__, |\__, |
#            |_|                  |___/ |___/

topology: [
  #                  ------ Vector Port Connection ------
  # Input -> Vector Port
  this.i1 -> vec_in_1.v1,
  this.i2 -> vec_in_2.v1,
  # Vector Port -> Output
  vec_out_1.v1 -> this.o1,
  vec_out_2.v1 -> this.o2,
  #                  ------ Vector Port Connection ------
  # Input Vector Port 1 Connection
  vec_in_1.v1->router_2.north,
  vec_in_1.v2->router_3.north,
  vec_in_1.v3->router_4.north,
  # Input Vector Port 2 Connection
  vec_in_2.v1->router_1.west,
  vec_in_2.v2->router_5.west,
  vec_in_2.v3->router_9.west,
  # Output Vector Port 1 Connection
  router_8.east->vec_out_1.v1,
  router_12.east->vec_out_1.v2,
  router_16.east->vec_out_1.v3,
  # Output Vector Port 2 Connection
  router_13.south->vec_out_2.v1,
  router_14.south->vec_out_2.v2,
  router_15.south->vec_out_2.v3,
  #                  ------ Router Connection ------
  # Router 1 Connection
  router_1.east->router_2.west,
  router_1.south->router_5.north,
  router_1.southeast->dedicated_pe_1.northwest,
  # Router 2 Connection
  router_2.west->router_1.east,
  router_2.southwest->dedicated_pe_1.northeast,
  router_2.south->router_6.north,
  router_2.southeast->dedicated_pe_2.northwest,
  router_2.east->router_3.west,
  # Router 3 Connection
  router_3.west->router_2.east,
  router_3.southwest->dedicated_pe_2.northeast,
  router_3.south->router_7.north,
  router_3.southeast->dedicated_pe_3.northwest,
  router_3.east->router_4.west,
  # Router 4 Connection
  router_4.west->router_3.east,
  router_4.southwest->dedicated_pe_3.northeast,
  router_4.south->router_8.north,
  # Router 5 Connection
  router_5.north->router_1.south,
  router_5.northeast->dedicated_pe_1.southwest,
  router_5.east->router_6.west,
  router_5.southeast->dedicated_pe_4.northwest,
  router_5.south->router_9.north,
  # Router 6 Connection
  router_6.west->router_5.east,
  router_6.northwest->dedicated_pe_1.southeast,
  router_6.north->router_2.south,
  router_6.northeast->dedicated_pe_2.southwest,
  router_6.east->router_7.west,
  router_6.southeast->dedicated_pe_5.northwest,
  router_6.south->router_10.north,
  router_6.southwest->dedicated_pe_4.northeast,
  # Router 7 Connection
  router_7.west->router_6.east,
  router_7.northwest->dedicated_pe_2.southeast,
  router_7.north->router_3.south,
  router_7.northeast->dedicated_pe_3.southwest,
  router_7.east->router_8.west,
  router_7.southeast->shared_pe_1.northwest,
  router_7.south->router_11.north,
  router_7.southwest->dedicated_pe_5.northeast,
  # Router 8 Connection
  router_8.west->router_7.east,
  router_8.northwest->dedicated_pe_3.southeast,
  router_8.north->router_4.south,
  router_8.south->router_12.north,
  router_8.southwest->shared_pe_1.northeast,
  # Router 9 Connection
  router_9.north->router_5.south,
  router_9.northeast->dedicated_pe_4.southwest,
  router_9.east->router_10.west,
  router_9.southeast->dedicated_pe_6.northwest,
  router_9.south->router_13.north,
  # Router 10 Connection
  router_10.west->router_9.east,
  router_10.northwest->dedicated_pe_4.southeast,
  router_10.north->router_6.south,
  router_10.northeast->dedicated_pe_5.southwest,
  router_10.east->router_11.west,
  router_10.southeast->dedicated_pe_7.northwest,
  router_10.south->router_14.north,
  router_10.southwest->dedicated_pe_6.northeast,
  # Router 11 Connection
  router_11.west->router_10.east,
  router_11.northwest->dedicated_pe_5.southeast,
  router_11.north->router_7.south,
  router_11.northeast->shared_pe_1.southwest,
  router_11.east->router_12.west,
  router_11.southeast->shared_pe_2.northwest,
  router_11.south->router_15.north,
  router_11.southwest->dedicated_pe_7.northeast,
  # Router 12 Connection
  router_12.west->router_11.east,
  router_12.northwest->shared_pe_1.southeast,
  router_12.north->router_8.south,
  router_12.south->router_16.north,
  router_12.southwest->shared_pe_2.northeast,
  # Router 13 Connection
  router_13.north->router_9.south,
  router_13.northeast->dedicated_pe_6.southwest,
  router_13.east->router_14.west,
  # Router 14 Connection
  router_14.west->router_13.east,
  router_14.northwest->dedicated_pe_6.southeast,
  router_14.north->router_10.south,
  router_14.northeast->dedicated_pe_7.southwest,
  router_14.east->router_15.west,
  # Router 15 Connection
  router_15.west->router_14.east,
  router_15.northwest->dedicated_pe_7.southeast,
  router_15.north->router_11.south,
  router_15.northeast->shared_pe_2.southwest,
  router_15.east->router_16.west,
  # Router 16 Connection
  router_16.west->router_15.east,
  router_16.northwest->shared_pe_2.southeast,
  router_16.north->router_12.south,
  #                  ------ Processing Elements Connection ------
  # Processing Element 1
  dedicated_pe_1.southeast->router_6.northwest,
  # Processing Element 2
  dedicated_pe_2.southwest->router_6.northeast,
  dedicated_pe_2.southeast->router_7.northwest,
  # Processing Element 3
  dedicated_pe_3.southeast->router_8.northwest,
  # Processing Element 4
  dedicated_pe_4.southeast->router_10.northwest,
  # Processing Element 5
  dedicated_pe_5.southeast->router_11.northwest,
  # Processing Element 6
  dedicated_pe_6.southeast->router_14.northwest,
  # Processing Element 7
  dedicated_pe_7.southeast->router_15.northwest,
  # Shared PE 1
  shared_pe_1.northwest->router_7.southeast,
  shared_pe_1.northeast->router_8.southwest,
  shared_pe_1.southwest->router_11.northeast,
  shared_pe_1.southeast->router_12.northwest,
  # Shared PE 2
  shared_pe_2.northwest->router_11.southeast,
  shared_pe_2.northeast->router_12.southwest,
  shared_pe_2.southwest->router_15.northeast,
  shared_pe_2.southeast->router_16.northwest
]